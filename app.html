<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ENTERPRISE DARK MINIMAL - Sistema de Transferencias
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    
    :root {
      /* Colores base */
      --bg-primary: #0f1117;
      --bg-secondary: #161921;
      --bg-tertiary: #1c1f2a;
      --bg-elevated: #22262f;
      
      /* Bordes y separadores */
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-default: rgba(255, 255, 255, 0.10);
      --border-strong: rgba(255, 255, 255, 0.16);
      
      /* Texto */
      --text-primary: #f4f4f5;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      
      /* Estados sem√°nticos */
      --success: #22c55e;
      --success-muted: rgba(34, 197, 94, 0.12);
      --warning: #eab308;
      --warning-muted: rgba(234, 179, 8, 0.12);
      --error: #ef4444;
      --error-muted: rgba(239, 68, 68, 0.12);
      --info: #3b82f6;
      --info-muted: rgba(59, 130, 246, 0.12);
      
      /* Espaciado y radios */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      
      /* Transiciones */
      --transition: 150ms ease;
    }

    /* Reset y base */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* Layout principal */
    .app-container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-subtle);
    }

    /* T√≠tulo */
    .app-title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 4px;
      
      /* Degradado Oro -> Naranja */
      background: linear-gradient(to right, #fbbf24, #d97706); 
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      
      display: inline-block;}
    

    .app-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
      max-width: 600px;
    }

    .header-meta {
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
      white-space: nowrap;
    }

    /* Navegaci√≥n por tabs */
    .nav-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 24px;
      padding: 4px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      width: fit-content;
    }

    /* Navegaci√≥n por tabs (Con May√∫sculas) */
    .nav-tab {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-family: inherit;
      font-size: 12px; 
      font-weight: 600; 
      text-transform: uppercase;
      letter-spacing: 0.05em; /* Separaci√≥n entre letras */
      
      transition: var(--transition);
    }

    .nav-tab:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    .nav-tab.active {
      background: #f59e0b; /* Fondo naranja dorado */
      color: #0f1117; /* Letra oscura para que se lea bien sobre el dorado */
      font-weight: 600;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); /* Un brillito sutil */
    }

    /* Cards */
    .card {
      /* Fondo semi-transparente para ver las luces de atr√°s */
      background: rgba(22, 25, 33, 0.75); 
      backdrop-filter: blur(12px); /* El efecto vidrio esmerilado */
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-xl);
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); /* Sombra suave */
    }
    
    /* Hacemos lo mismo con las tarjetas internas */
    .inner-card {
      background: rgba(30, 34, 45, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-lg);
      padding: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .card-description {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Grid layouts */
    .grid-2col {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
    }

    .grid-4col {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .grid-2col-uneven {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 16px;
    }

    @media (max-width: 1024px) {
      .grid-2col, .grid-2col-uneven {
        grid-template-columns: 1fr;
      }
      .grid-4col {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .grid-4col {
        grid-template-columns: 1fr;
      }
    }

    /* KPI Cards */
    .kpi-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 16px;
    }

    .kpi-label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-top: 8px;
      letter-spacing: -0.02em;
    }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-default);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: var(--font-main);
      transition: var(--transition);
      outline: none;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--border-strong);
      background: var(--bg-elevated);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap; /* Importante para que no se estire al infinito */
}

.form-row > .form-group {
  flex: 1;
  min-width: 120px; /* Evita que los campos se achiquen demasiado */
}

    .form-row > * {
      flex: 1;
    }

    /* Buttons */
    /* Bot√≥n Base */
    /* Bot√≥n Base (Corregido) */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px; 
      border-radius: 8px; /* Un poco menos redondeado para que sea m√°s serio */
      border: 1px solid var(--border-default);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-primary);
      
      /* AC√Å EST√Å EL CAMBIO CLAVE: */
      font-family: inherit; /* Hereda la fuente Inter del cuerpo */
      font-size: 13px;
      font-weight: 500; /* Bajamos de 600 a 500 (Medium) para que no sea tan tosco */
      letter-spacing: normal; /* Quitamos el espaciado extra */
      
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    /* BOT√ìN PRIMARIO */
    /* BOT√ìN DORADO/NARANJA */
    .btn-primary {
      /* Degradado √Åmbar */
      background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
      border: none;
      color: #ffffff; /* Texto blanco para contraste */
      /* Sombra/Resplandor dorado */
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.35); 
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #fbbf24 0%, #ea580c 100%); /* M√°s brillo al pasar el mouse */
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
      transform: translateY(-2px);
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Status badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid transparent;
    }

    .badge-success {
      color: var(--success);
      background: var(--success-muted);
      border-color: rgba(34, 197, 94, 0.25);
    }

    .badge-warning {
      color: var(--warning);
      background: var(--warning-muted);
      border-color: rgba(234, 179, 8, 0.25);
    }

    .badge-error {
      color: var(--error);
      background: var(--error-muted);
      border-color: rgba(239, 68, 68, 0.25);
    }

    .badge-info {
      color: var(--info);
      background: var(--info-muted);
      border-color: rgba(59, 130, 246, 0.25);
    }

    .badge-neutral {
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      border-color: var(--border-default);
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead th {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
      text-align: left;
      padding: 10px 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-default);
    }

    .data-table tbody td {
      padding: 12px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 13px;
      vertical-align: middle;
    }

    .data-table tbody tr:hover {
      background: var(--bg-tertiary);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    .data-table .amount {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    /* Links */
    a {
      color: var(--text-primary);
      text-decoration: none;
      transition: var(--transition);
    }

    a:hover {
      color: var(--text-secondary);
    }

    /* Status messages */
    .status-message {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 12px;
    }

    /* Upload zone */
    .upload-container {
      border: 1px dashed var(--border-strong);
      border-radius: var(--radius-lg);
      padding: 16px;
      background: var(--bg-tertiary);
    }

    .upload-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .drop-zone {
      flex: 1;
      min-width: 240px;
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      background: var(--bg-secondary);
      transition: var(--transition);
      text-align: center;
    }

    .drop-zone:hover {
      border-color: var(--border-strong);
      background: var(--bg-elevated);
    }

    .drop-zone.dragging {
      border-color: var(--text-primary);
      background: var(--bg-elevated);
    }

    .drop-zone-title {
      font-weight: 500;
      color: var(--text-primary);
    }

    .drop-zone-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .upload-preview {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 12px;
    }

    .upload-thumbnail {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-default);
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .upload-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .upload-info {
      flex: 1;
    }

    .upload-filename {
      font-weight: 500;
      color: var(--text-primary);
    }

    .upload-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Modal (tu modal grande) */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 1000;
    }

    .modal-container {
      width: min(800px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }

    .modal-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: 8px;
    }

    .modal-body {
      padding: 20px;
    }

    /* Section title (inside cards) */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    /* Chip (small info tag) */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 9999px;
      border: 1px solid var(--border-default);
      background: var(--bg-tertiary);
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Utility classes */
    .hidden { display: none !important; }
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .mt-4 { margin-top: 16px; }
    .mt-3 { margin-top: 12px; }
    .mt-2 { margin-top: 8px; }
    .mb-4 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 12px; }
    .gap-2 { gap: 8px; }
    .gap-3 { gap: 12px; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .flex-wrap { flex-wrap: wrap; }

    /* Divider */
    .divider {
      height: 1px;
      background: var(--border-subtle);
      margin: 16px 0;
    }

    /* Inner card (nested) */
    .inner-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 16px;
    }

    /* Quick actions list */
    .action-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .action-list .btn {
      width: 100%;
      justify-content: flex-start;
    }

    /* Help text */
    .help-text {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    /* Mode selector row */
    .filter-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
      margin: 16px 0;
    }

    .filter-item {
      min-width: 200px;
    }

    /* Selected user box */
    .selected-profile {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 16px;
    }

    .profile-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .profile-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .app-container {
        padding: 16px;
      }
      
      .app-header {
        flex-direction: column;
        gap: 12px;
      }
      
      .header-meta {
        text-align: left;
      }
      
      .nav-tabs {
        width: 100%;
        overflow-x: auto;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-item {
        min-width: 100%;
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       POPUP (UI Alert/Confirm) + TOASTS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    .toast-wrap{
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1300;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast{
      pointer-events: none;
      min-width: 240px;
      max-width: 420px;
      background: rgba(22,25,33,0.92);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      padding: 12px 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
      animation: toastIn 160ms ease;
    }
    @keyframes toastIn{
      from { transform: translateY(-6px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }
    .toast-title{
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .toast-msg{
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-primary);
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .toast.success{ border-color: rgba(34,197,94,0.25); }
    .toast.warn{ border-color: rgba(234,179,8,0.25); }
    .toast.error{ border-color: rgba(239,68,68,0.28); }
    .toast.info{ border-color: rgba(59,130,246,0.25); }

    .popup-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.62);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 1400; /* arriba del modal grande */
    }
    .popup{
      width: min(520px, 100%);
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      box-shadow: 0 24px 60px rgba(0,0,0,0.55);
      overflow: hidden;
    }
    .popup-head{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .popup-title{
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .popup-tone{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .popup-body{
      padding: 16px;
    }
    .popup-msg{
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .popup-actions{
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 14px 16px 16px;
      border-top: 1px solid var(--border-subtle);
      background: rgba(28,31,42,0.35);
    }

    .btn-danger{
      background: rgba(239,68,68,0.14);
      border-color: rgba(239,68,68,0.25);
      color: #fecaca;
    }
    .btn-danger:hover{
      background: rgba(239,68,68,0.20);
      border-color: rgba(239,68,68,0.35);
    }

/* --- AVISO LATENTE (NUEVO) --- */
    .sync-banner {
      background: rgba(234, 179, 8, 0.15); /* Fondo amarillo transparente */
      border: 1px solid #eab308;            /* Borde amarillo ne√≥n */
      color: #fef08a;                       /* Texto amarillo claro */
      padding: 16px;
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(234, 179, 8, 0.1);
      animation: pulse-border 2s infinite; /* El efecto latente */
    }

    @keyframes pulse-border {
      0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); }
      100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
    }

    .sync-text {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ILUMINACI√ìN AMBIENTAL (FONDO ANIMADO)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    
    .ambient-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      z-index: -1; /* Se queda atr√°s de todo */
      pointer-events: none; /* No interfiere con los clics */
      background: var(--bg-primary); /* Fondo base */
    }

    .light-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px); /* El secreto: mucho desenfoque */
      opacity: 0.4; /* Sutil */
      animation: floatOrb 12s ease-in-out infinite alternate;
    }

    /* Foco 1: Azul (Arriba Izquierda) */
    .orb-blue {
      top: -10%;
      left: -10%;
      width: 50vw;
      height: 50vw;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.25) 0%, transparent 70%);
    }

    /* Foco 2: Dorado (Abajo Derecha) */
    .orb-gold {
      bottom: -10%;
      right: -10%;
      width: 60vw;
      height: 60vw;
      background: radial-gradient(circle, rgba(234, 179, 8, 0.15) 0%, transparent 70%);
      animation-delay: -5s; /* Para que no se muevan igual */
    }

    /* Foco 3: Violeta (Centro sutil) */
    .orb-purple {
      top: 40%;
      left: 30%;
      width: 40vw;
      height: 40vw;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
      animation-duration: 18s;
    }

    @keyframes floatOrb {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(40px, 60px) scale(1.1); }
    }

   /* Ajuste espec√≠fico para la tabla de Sin Match */
    #t3 .data-table th:nth-child(4),
    #t3 .data-table td:nth-child(4),
    #t3 .data-table th:nth-child(5),
    #t3 .data-table td:nth-child(5) {
      text-align: center;
      width: 1%; /* Esto hace que la columna se achique al tama√±o del bot√≥n */
      white-space: nowrap; /* Evita que el texto se parta */
    }

  </style>
</head>
<body>
  <? var __TITLE__ = (typeof appTitle !== 'undefined' && appTitle) ? appTitle : 'Atenea'; ?>

  <div class="ambient-bg">
    <div class="light-orb orb-blue"></div>
    <div class="light-orb orb-gold"></div>
    <div class="light-orb orb-purple"></div>
  </div>
  
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div>
        <h1 class="app-title"><?= __TITLE__ ?></h1>
        <p class="app-subtitle">Sistema de registro y reconciliacion de transferencias.</p>
      </div>
      <div class="header-meta" id="topRight">-</div>
    </header>

    <!-- Navigation -->
    <nav class="nav-tabs">
      <button class="nav-tab active" id="tab0" onclick="showTab('t0')">DASHBOARD</button>
      <button class="nav-tab" id="tab1" onclick="showTab('t1')">NUEVA TRANSFERENCIA</button>
      <button class="nav-tab" id="tab4" onclick="showTab('t4')">üìù ANOTACIONES</button> 
      
      <button class="nav-tab" id="tab2" onclick="showTab('t2')">CARGA DE DATOS</button>
      <button class="nav-tab" id="tab3" onclick="showTab('t3')">SIN MATCH</button>
      <button class="nav-tab" id="btnControl" onclick="handleControlAccess()">üîí REPORTE CONTROL</button>
      <button class="nav-tab" id="tab5" onclick="showTab('t5')">‚ö†Ô∏è CIERRE</button>
    </nav>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         TAB 0: DASHBOARD
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="t0">
    
      <div id="syncAlert" class="sync-banner hidden">
        <div class="sync-text">
          ‚ö†Ô∏è <span>Nuevos datos cargados. Es necesario sincronizar para actualizar los estados.</span>
        </div>
        <button class="btn btn-primary" style="background: #eab308; border-color: #eab308; color: #000;" onclick="syncTransfers()">
          Sincronizar ahora
        </button>
      </div>

      <div class="card">
       <div class="card-header">
          <div>
            <h2 class="card-title">Dashboard (√∫ltimas 24 hs)</h2>
            <p class="card-description">
              Actualizaci√≥n autom√°tica cada 20s. √öltima: <span id="dashUpdated">-</span>
              <span class="chip" style="margin-left: 8px;" id="dashWindow">-</span>
            </p>
          </div>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="syncTransfers()">Sincronizar transferencias</button>
            <button class="btn" onclick="showTab('t1')">Nueva transferencia</button>
          </div>
        </div>

        <div class="grid-4col">
          <div class="kpi-card">
            <div class="kpi-label">Transferencias (24hs)</div>
            <div class="kpi-value" id="k_total">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Matcheadas</div>
            <div class="kpi-value" id="k_match">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Pendientes</div>
            <div class="kpi-value" id="k_pend">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Sin Match</div>
            <div class="kpi-value" id="k_nomatch">0</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="inner-card" style="margin-bottom: 20px;">
          <h3 class="section-title">Ingresos Manuales (√öltimos 7 d√≠as)</h3>
          <div style="height: 250px; width: 100%;">
            <canvas id="kpiChart"></canvas>
          </div>
        </div>

        <div class="grid-2col-uneven">
          
          <div class="inner-card">
            <h3 class="section-title">√öltimas transferencias</h3>
            
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>CLIENTE</th>
                    <th>MONTO</th>
                    <th>HORA</th>
                    <th>ESTADO</th>
                    <th>NOTAS</th>
                    <th>ACCI√ìN</th>
                  </tr>
                </thead>
                <tbody id="dashLatest">
                  <tr><td colspan="5" style="text-align:center; padding:20px; color:#666;">Cargando datos...</td></tr>
                </tbody>
              </table>
            </div>

            <div class="pagination" style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
              <button class="btn" id="btnPrev" onclick="changeDashPage(-1)" disabled>Anterior</button>
              <span class="page-info" id="pageIndicator" style="font-size:12px; align-self:center;">P√°gina 1</span>
              <button class="btn" id="btnNext" onclick="changeDashPage(1)" disabled>Siguiente</button>
            </div>
          </div>

          <div class="inner-card">
            <h3 class="section-title">Acciones r√°pidas</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
              <button class="btn" onclick="showTab('t3'); loadNoMatch();">Ver Sin Match</button>
              <button class="btn" onclick="document.getElementById('csvFileQuick').click()">Cargar CSV billetera</button>
              <input type="file" id="csvFileQuick" accept=".csv" style="display:none" onchange="uploadCsv('quick')">
            </div>
            <p style="margin-top:15px; font-size:11px; color:#666; line-height:1.4;">
              "Sincronizar transferencias" recalcula Match/Sin match de las √∫ltimas 24hs.
            </p>
          </div>
        
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         TAB 1: NUEVA TRANSFERENCIA / PERFIL
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="t1" class="hidden">
      <div class="grid-2col">
        
        <div class="card">
          <h2 class="card-title">Crear perfil</h2>
          
          <div class="form-group">
            <label class="form-label">Nombre exacto (tal cual comprobante)</label>
            <input class="form-input" id="newName" />
          </div>
          
          <div class="form-group">
            <label class="form-label">CUIL/CUIT (opcional)</label>
            <input class="form-input" id="newCuil" placeholder="20-37963124-0" />
          </div>

          <div class="form-group">
  <label class="form-label">USUARIO BEAST (Extra)</label>
  <input class="form-input" id="newBeastId" placeholder="Referencia para Beast" />
</div>
          
          <button class="btn btn-primary" onclick="createUser()">Crear perfil</button>
          <div class="status-message" id="stCreateUser"></div>

          <div class="divider"></div>

          <h3 class="section-title">Buscar perfil</h3>
          
          <div class="form-group">
            <label class="form-label">Buscar por nombre, CUIL o usuario BEAST</label>
            <div class="form-row">
              <input class="form-input" id="qUser" />
              <button class="btn" style="flex: 0 0 auto;" onclick="searchUsers()">Buscar</button>
            </div>
          </div>
          <div class="status-message" id="stSearchUser"></div>

          <table class="data-table mt-3">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>CUIL</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="userRows"></tbody>
          </table>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
            <button class="btn" id="btnPrevUser" onclick="changeUserPage(-1)" disabled>Anterior</button>
            <span style="font-size: 12px; color: var(--text-muted);" id="userPageIndicator">P√°gina 1</span>
            <button class="btn" id="btnNextUser" onclick="changeUserPage(1)" disabled>Siguiente</button>
          </div>

        </div> <div class="card">
          <h2 class="card-title">Perfil seleccionado</h2>
          <p class="text-muted" id="selEmpty">Selecciona un perfil para cargar transferencia.</p>

          <div id="selBox" class="hidden">
  <div class="selected-profile">
    <div>
      <div class="profile-name" id="selNombre"></div>
      <div class="profile-meta">
        CUIL: <span id="selCuil"></span> | ID: <span id="selId"></span>
      </div>
      <div style="margin-top: 5px; font-size: 13px; color: #fbbf24; font-weight: 600;">
        BEAST ID: <span id="selBeast">-</span>
      </div>
    </div>
    <button class="btn" onclick="openEditUser()">Editar perfil</button>
  </div>

  <h3 class="section-title">Nueva transferencia</h3>

  <div class="form-row mb-3">
    <div class="form-group">
      <label class="form-label">Turno</label>
      <select class="form-select" id="turno">
        <option value="">Seleccionar</option>
        <option value="MANANA">MANANA</option>
        <option value="TARDE">TARDE</option>
        <option value="NOCHE">NOCHE</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Fecha</label>
      <input class="form-input" id="fecha" type="date" />
    </div>
    <div class="form-group">
      <label class="form-label">Hora</label>
      <input class="form-input" id="hora" type="time" />
    </div>
  </div>

  <div class="form-row mb-3">
    <div class="form-group">
      <label class="form-label">Billetera</label>
      <select class="form-select" id="billetera">
        <option value="MANZO">MANZO</option>
        <option value="AMFRIS">AMFRIS</option>
        <option value="BARROSO">BARROSO</option>
        <option value="DC">DC</option>
        <option value="OTRA">OTRA</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Monto</label>
      <input class="form-input" id="monto" type="number" />
    </div>
    <div class="form-group">
      <label class="form-label">Nota (opcional)</label>
      <input class="form-input" id="nota" />
    </div>
  </div>

  <h4 class="section-title" style="font-size: 13px;">Comprobante (opcional)</h4>
  <div class="upload-container">
    <div class="upload-row">
      <div class="drop-zone" id="dropZone" onclick="pickComprobante()">
        <div class="drop-zone-title">Arrastra o haz click</div>
        <div class="drop-zone-hint">PNG/JPG/PDF - max 6 MB</div>
      </div>
      <div class="btn-group">
        <button class="btn" onclick="saveTransfer()">Guardar transferencia</button>
        <button class="btn" onclick="refreshUserTransfers()">Refrescar</button>
      </div>
    </div>
    </div>
</div>
              <input id="upFile" type="file" accept="image/png,image/jpeg,image/webp,application/pdf" class="hidden" />
              <div class="upload-preview hidden" id="upPrev">
                <div class="upload-thumbnail" id="upThumb"></div>
                <div class="upload-info">
                  <div class="upload-filename" id="upName"></div>
                  <div class="upload-meta" id="upInfo"></div>
                </div>
              </div>
              <div class="status-message" id="upStatus"></div>
            </div>

            <div class="mt-4">
              <div class="btn-group">
                <button class="btn btn-primary" onclick="saveTransfer()">Guardar transferencia</button>
                <button class="btn" onclick="refreshUserTransfers()">Refrescar</button>
              </div>
            </div>
            <div class="status-message" id="stCreateTransfer"></div>

            <div class="divider"></div>

            <h3 class="section-title">Ultimas transferencias</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Fecha/Hora</th>
                  <th>Monto</th>
                  <th>Estado</th>
                  <th>Comprobante</th>
                  <th>Notas</th>
                  <th>Acci√≥n</th> </tr>
              </thead>
              <tbody id="transferRows"></tbody>
            </table>
          </div>
        </div> </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         TAB 2: CARGA CSV
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="t2" class="hidden">
      <div class="card">
        <h2 class="card-title">Carga de datos (Movimientos_Billetera)</h2>
        <p class="card-description">
          Subi un CSV con columnas: <strong>Fecha, ID, Monto, Destinario/Origen, CUIL/CUIT</strong>.
        </p>

        <div class="mt-4">
          <input type="file" class="form-input" id="csvFileTab" accept=".csv,text/csv" style="padding: 8px;" />
        </div>
        
        <div class="mt-4">
          <button class="btn btn-primary" onclick="uploadCsv('tab')">Importar CSV</button>
        </div>
        <div class="status-message" id="stCsv"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         TAB 3: NO MATCH
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="t3" class="hidden">
      <div class="grid-2col-uneven">
        
        <div class="card">
          <h2 class="card-title">Transferencias Fallidas (Sin Match)</h2>
          <p class="card-description">Cargas manuales que el sistema no encontr√≥ en la billetera.</p>
          
          <div class="filter-row">
             <button class="btn btn-primary" onclick="loadNoMatch()">Recargar lista</button>
          </div>

          <table class="data-table mt-4">
            <thead>
              <tr>
                <th>USUARIO</th>
                <th>FECHA/HORA</th>
                <th>MONTO</th>
                <th>COMPROBANTE</th> 
                <th>ACCI√ìN</th>
              </tr>
            </thead>
            <tbody id="noMatchRows"></tbody>
          </table>
          <div class="status-message" id="stNoMatch"></div>
        </div>

        <div class="card" style="border-color: rgba(234, 179, 8, 0.3);">
          <h2 class="card-title" style="color: #fef08a;">‚ö†Ô∏è Ingresos No Registrados</h2>
          <p class="card-description">Dinero real entrante (Ayer y Hoy) sin asignar.</p>
          
          <div class="filter-row" style="gap: 8px;">
             <input id="qOrphan" class="form-input" placeholder="Buscar titular o monto..." onkeyup="if(event.key==='Enter') loadOrphans()">
             <button class="btn" onclick="loadOrphans()">Buscar</button>
          </div>

          <table class="data-table mt-4">
            <thead>
              <tr>
                <th>Titular</th>
                <th>Fecha</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody id="orphanRows"></tbody>
          </table>
          <div class="status-message" id="stOrphans"></div>
        </div>

      </div>
    </div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         TAB 4
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="t4" class="hidden">
      <div class="card">
        <div class="card-header">
           <div>
             <h2 class="card-title">Transferencias con Anotaciones</h2>
             <p class="card-description">Listado filtrado de operaciones que tienen notas adicionales.</p>
           </div>
           <button class="btn btn-primary" onclick="loadNotesTab()">üîÑ Actualizar lista</button>
        </div>

        <table class="data-table">
          <thead>
            <tr>
              <th>FECHA</th>
              <th>CLIENTE</th>
              <th>MONTO</th>
              <th>NOTA</th>
              <th>ACCI√ìN</th>
            </tr>
          </thead>
          <tbody id="notesRows">
             <tr><td colspan="5" style="text-align:center; padding:20px;">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

       <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         TAB 5
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
     <div id="t5" class="hidden">
      <div class="card" style="border-color: rgba(239, 68, 68, 0.3);">
        <div class="card-header">
          <div>
            <h2 class="card-title" style="color: #f87171;">Zona de Cierre</h2>
            <p class="card-description">Opciones de limpieza masiva. Requieren contrase√±a administrativa.</p>
          </div>
        </div>

        <div class="grid-2col">
          <div class="inner-card">
            <h3 class="section-title">Espacio en Drive</h3>
            <p class="help-text mb-4">
              Esta acci√≥n vac√≠a la carpeta de comprobantes en Google Drive para liberar espacio.
              Los archivos se env√≠an a la papelera.
            </p>
            <button class="btn btn-danger" style="width: 100%;" onclick="handleCleanDrive()">
              üóëÔ∏è Borrar todos los comprobantes
            </button>
          </div>

          <div class="inner-card">
            <h3 class="section-title">Base de Datos (Reset)</h3>
            <p class="help-text mb-4">
              Elimina TODAS las transferencias, movimientos de billetera y reportes de control.
              <br><strong>Los Clientes (Usuarios) NO se borran.</strong>
            </p>
            <button class="btn btn-danger" style="width: 100%;" onclick="handleCleanHistory()">
              üí• Borrar historial de transferencias
            </button>
          </div>

          <div class="inner-card" style="grid-column: span 2;"> <h3 class="section-title">Auditor√≠a del Sistema</h3>
            <p class="help-text mb-4">
              Revisar qui√©n cre√≥ usuarios, elimin√≥ transferencias o modific√≥ datos.
            </p>
            <button class="btn" style="width: 100%; border-color: var(--text-secondary);" onclick="openLogs()">
              üìú Ver Logs de Actividad
            </button>
          </div>
        </div>

        <div class="status-message" id="stCierre"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MODAL (tu modal grande de edici√≥n)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="modalBack">
      <div class="modal-container">
        <div class="modal-header">
          <div>
            <span class="modal-title" id="modalTitle">Editar</span>
            <span class="modal-subtitle" id="modalSub"></span>
          </div>
          <button class="btn" onclick="closeModal()">Cerrar</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- POPUP ALERT/CONFIRM (dentro de UI) -->
  <div class="popup-overlay" id="popupBack" role="dialog" aria-modal="true">
    <div class="popup">
      <div class="popup-head">
        <div>
          <div class="popup-title" id="popupTitle">Aviso</div>
          <div class="popup-tone" id="popupTone"></div>
        </div>
        <button class="btn" onclick="popupClose(false)">Cerrar</button>
      </div>
      <div class="popup-body">
        <div class="popup-msg" id="popupMsg"></div>
      </div>
      <div class="popup-actions" id="popupActions"></div>
    </div>
  </div>

<script>
  let chartInstance = null;
  let selectedUser = null;
  const UP = { base64:null, mime:null, name:null, size:0 };

  function status(id, msg){
    const el = document.getElementById(id);
    if (!el) return;            // ‚úÖ si no existe, no rompe nada
    el.textContent = msg || '';
  }

  function setTabBtn(activeId){
    ['tab0','tab1','tab2','tab3','tab5'].forEach(id=>{ // Agregado tab5
      document.getElementById(id).classList.toggle('active', id===activeId);
    });
  }
  function showTab(id){
      ['t0','t1','t2','t3','t5'].forEach(t=>document.getElementById(t).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      
      let btn='tab0';
      if(id==='t1') btn='tab1';
      else if(id==='t2') btn='tab2';
      else if(id==='t3') btn='tab3';
      else if(id==='t5') btn='tab5';
      
      setTabBtn(btn);

      // NUEVO: Si entramos a t3, cargamos ambas listas
      if(id === 't3') {
        loadNoMatch(); 
        loadOrphans();
      }
    }

  // -------------------- SEGURIDAD Y REPORTE --------------------
  
  function handleControlAccess() {
    // 1. Pedir contrase√±a (Login b√°sico)
    // Esto es temporal hasta que hagamos un sistema de usuarios real en la base de datos.
    const password = prompt("üîê Zona Restringida\nIngresa la clave de administraci√≥n:");
    
    if (!password) return; // Cancel√≥

    // Feedback visual inmediato
    const btn = document.getElementById('btnControl');
    const originalText = btn.textContent;
    btn.textContent = "‚è≥ Generando...";
    btn.disabled = true;

    // 2. Llamar al backend
    google.script.run
      .withFailureHandler(err => {
        alert("Error: " + err.message);
        btn.textContent = originalText;
        btn.disabled = false;
      })
      .withSuccessHandler(res => {
        btn.textContent = originalText;
        btn.disabled = false;

        if (res.error) {
          alert("‚õî " + res.error); // Contrase√±a incorrecta
        } else if (res.success && res.url) {
          // 3. Abrir el Sheet en nueva pesta√±a
          // Usamos window.open para ir directo al documento relleno
          window.open(res.url, '_blank');
          toast('Reporte actualizado y abierto.', 'success');
        }
      })
      .updateAndGetControlUrl(password);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // UI POPUPS / TOASTS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  let __popupResolve = null;

  function popupClose(result){
    const back = document.getElementById('popupBack');
    back.style.display = 'none';
    if (__popupResolve) {
      const r = __popupResolve;
      __popupResolve = null;
      r(result);
    }
  }

  // ESC para cerrar (si hay popup abierto)
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') {
      const back = document.getElementById('popupBack');
      if (back && back.style.display === 'flex') popupClose(false);
    }
  });

  function toast(message, tone='info', title='Atenea'){
    const wrap = document.getElementById('toastWrap');
    const el = document.createElement('div');
    el.className = `toast ${tone==='success'?'success':tone==='warn'?'warn':tone==='error'?'error':'info'}`;
    el.innerHTML = `
      <div class="toast-title">${esc(title)}</div>
      <div class="toast-msg">${esc(message)}</div>
    `;
    wrap.appendChild(el);
    setTimeout(()=>{ try { el.remove(); } catch(_){} }, 2800);
  }

  function uiAlert(title, message, tone='info'){
    const back = document.getElementById('popupBack');
    document.getElementById('popupTitle').textContent = title || 'Aviso';
    document.getElementById('popupMsg').textContent = message || '';
    document.getElementById('popupTone').textContent = tone === 'error' ? 'Error' : tone === 'warn' ? 'Atenci√≥n' : 'Info';

    const actions = document.getElementById('popupActions');
    actions.innerHTML = `<button class="btn btn-primary" onclick="popupClose(true)">Aceptar</button>`;

    back.style.display = 'flex';
    return new Promise(resolve => { __popupResolve = resolve; });
  }

  function uiConfirm({ title='Confirmar', message='', okText='Aceptar', cancelText='Cancelar', tone='warn', danger=false }){
    const back = document.getElementById('popupBack');
    document.getElementById('popupTitle').textContent = title;
    document.getElementById('popupMsg').textContent = message;
    document.getElementById('popupTone').textContent = tone === 'error' ? 'Cr√≠tico' : tone === 'warn' ? 'Confirmaci√≥n' : 'Info';

    const actions = document.getElementById('popupActions');
    actions.innerHTML = `
      <button class="btn" onclick="popupClose(false)">${esc(cancelText)}</button>
      <button class="btn ${danger ? 'btn-danger' : 'btn-primary'}" onclick="popupClose(true)">${esc(okText)}</button>
    `;

    back.style.display = 'flex';
    return new Promise(resolve => { __popupResolve = resolve; });
  }

  // ---- uploader UI
  const dropZone = document.getElementById('dropZone');
  const upFile = document.getElementById('upFile');

  dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('dragging'); });
  dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('dragging'));
  dropZone.addEventListener('drop', async (e)=>{
    e.preventDefault();
    dropZone.classList.remove('dragging');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f) await setComprobante(f);
  });

  upFile.addEventListener('change', async ()=>{
    const f = upFile.files && upFile.files[0];
    if (f) await setComprobante(f);
  });

  function pickComprobante(){ upFile.click(); }

  async function setComprobante(file){
    status('upStatus','');
    if (!file) return;
    const max = 6 * 1024 * 1024;
    if (file.size > max) { clearComprobante(); return status('upStatus','Archivo muy grande (max 6 MB).'); }
    const okTypes = ['image/png','image/jpeg','image/webp','application/pdf'];
    const mt = file.type || '';
    if (mt && !okTypes.includes(mt)) { clearComprobante(); return status('upStatus','Tipo no soportado. Usa PNG/JPG/WEBP/PDF.'); }
    const b64 = await fileToBase64(file);

    UP.base64 = b64;
    UP.mime = mt || 'application/octet-stream';
    UP.name = file.name || 'comprobante';
    UP.size = file.size || 0;

    document.getElementById('upPrev').classList.remove('hidden');
    document.getElementById('upName').textContent = UP.name;
    document.getElementById('upInfo').textContent = `${Math.round(UP.size/1024)} KB | ${UP.mime || 'archivo'}`;

    const thumb = document.getElementById('upThumb');
    thumb.innerHTML = '';
    if (UP.mime === 'application/pdf') thumb.textContent = 'PDF';
    else {
      const img = document.createElement('img');
      img.src = 'data:' + UP.mime + ';base64,' + UP.base64;
      thumb.appendChild(img);
    }
    status('upStatus','Comprobante listo (se sube cuando guardas la transferencia).');
  }

  function clearComprobante(){
    UP.base64 = null; UP.mime = null; UP.name = null; UP.size = 0;
    upFile.value = '';
    document.getElementById('upPrev').classList.add('hidden');
    document.getElementById('upThumb').innerHTML = '';
    document.getElementById('upName').textContent = '';
    document.getElementById('upInfo').textContent = '';
    status('upStatus','');
  }

  // -------- Users
  function createUser() {
  // 1. Capturamos los datos de los inputs
  const nombre = document.getElementById('newName').value;
  const cuil = document.getElementById('newCuil').value;
  const beast = document.getElementById('newBeastId').value;

  if (!nombre) {
    status('stCreateUser', '‚ùå El nombre es obligatorio');
    return;
  }

  status('stCreateUser', '‚è≥ Creando perfil...');

  // 2. Ejecutamos el env√≠o al servidor
  google.script.run
    .withFailureHandler(err => {
      status('stCreateUser', '‚ùå Error de red: ' + err.message);
    })
    .withSuccessHandler(res => {
      if (res.error) {
        status('stCreateUser', '‚ùå ' + res.error);
      } else {
        toast('Perfil creado con √©xito ‚úÖ', 'success');
        status('stCreateUser', '‚úÖ Perfil creado.');
        
        // Limpiamos los campos
        document.getElementById('newName').value = '';
        document.getElementById('newCuil').value = '';
        document.getElementById('newBeastId').value = '';
        
        // Refrescamos la lista de b√∫squeda autom√°ticamente
        searchUsers(); 
      }
    })
    .createUser({
      nombre_canonico: nombre,
      cuit_cuil: cuil,
      user_id_beast: beast // Se env√≠a correctamente al .gs
    });
}

  
// --- VARIABLES PAGINACI√ìN USUARIOS ---
  let USER_DATA = [];
  let USER_PAGE = 1;
  const USER_SIZE = 10;

  // --- VARIABLES PAGINACI√ìN DASHBOARD ---
  let DASH_DATA = [];
  let DASH_PAGE = 1;
  const DASH_SIZE = 5; 

  // 1. Modificar la funci√≥n searchUsers existente
  function searchUsers(){
    status('stSearchUser','Buscando...');
    const q = document.getElementById('qUser').value;

    google.script.run.withFailureHandler(err=>{
      status('stSearchUser','Error: ' + (err && err.message ? err.message : err));
    }).withSuccessHandler(rows=>{
      // GUARDAMOS TODO EN LA VARIABLE GLOBAL
      USER_DATA = rows || [];
      USER_PAGE = 1; // Reseteamos a p√°g 1
      
      renderUserTable(); // Dibujamos la tabla paginada

      if (!q) {
        status('stSearchUser', `Total usuarios: ${USER_DATA.length}`);
      } else {
        status('stSearchUser', `${USER_DATA.length} resultado(s).`);
      }
    }).searchUsers(q);
  }

  // 2. Funciones de Paginaci√≥n y Renderizado
  function changeUserPage(delta) {
    const maxPage = Math.ceil(USER_DATA.length / USER_SIZE) || 1;
    const newPage = USER_PAGE + delta;
    if (newPage >= 1 && newPage <= maxPage) {
      USER_PAGE = newPage;
      renderUserTable();
    }
  }

  function renderUserTable() {
    const tb = document.getElementById('userRows');
    tb.innerHTML = '';

    // Slice para paginar
    const start = (USER_PAGE - 1) * USER_SIZE;
    const end = start + USER_SIZE;
    const pageItems = USER_DATA.slice(start, end);

    pageItems.forEach(u => {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <div style="font-weight: 500;">üë§ ${esc(u.nombre_canonico||'')}</div>
      <div style="font-size: 10px; color: #fbbf24;">Beast: ${esc(u.user_id_beast || '-')}</div>
    </td>
    <td style="font-size: 11px;">${esc(u.cuit_cuil||'')}</td>
    <td><button class="btn" onclick="selectUser('${u.user_id}')">Abrir</button></td>
  `;
  tb.appendChild(tr);
});

    // Actualizar controles
    const maxPage = Math.ceil(USER_DATA.length / USER_SIZE) || 1;
    document.getElementById('userPageIndicator').textContent = `P√°gina ${USER_PAGE} de ${maxPage}`;
    document.getElementById('btnPrevUser').disabled = (USER_PAGE === 1);
    document.getElementById('btnNextUser').disabled = (USER_PAGE >= maxPage);
  }

  // 3. Formateador de CUIL (Auto-guiones)
  // Agreg√° este listener al final de tu script, fuera de las funciones
  document.addEventListener('DOMContentLoaded', () => {
    // Al cargar, disparar b√∫squeda para ver la lista completa
    searchUsers();

    // Input Mask para el CUIL Nuevo
    const inputCuil = document.getElementById('newCuil');
    if (inputCuil) {
      inputCuil.addEventListener('input', function(e) {
        let v = e.target.value.replace(/\D/g, '').substring(0, 11); // Solo nums, max 11
        // Formato XX-XXXXXXXX-X
        if (v.length > 2) v = v.slice(0, 2) + '-' + v.slice(2);
        if (v.length > 11) v = v.slice(0, 11) + '-' + v.slice(11);
        e.target.value = v;
      });
    }
  });

  function selectUser(user_id){
    google.script.run.withSuccessHandler(u=>{
    selectedUser = u;
    document.getElementById('selEmpty').classList.add('hidden');
    document.getElementById('selBox').classList.remove('hidden');
    document.getElementById('selNombre').textContent = u.nombre_canonico || '';
    document.getElementById('selCuil').textContent = u.cuit_cuil || '-';
    document.getElementById('selId').textContent = u.user_id || '';
    document.getElementById('selBeast').textContent = u.user_id_beast || '-'; // <-- NUEVO
    clearComprobante();
    refreshUserTransfers();
  }).getUser(user_id);
}

  function refreshUserTransfers(){
  if (!selectedUser) return;
  google.script.run.withFailureHandler(err=>{
    console.log(err);
  }).withSuccessHandler(rows=>{
    const tb = document.getElementById('transferRows');
    tb.innerHTML='';
    (rows||[]).forEach(r=>{
      const tr = document.createElement('tr');
      const hasNote = (r.nota && r.nota.includes('|')); 

      tr.innerHTML = `
        <td>${esc(r.fecha_hora_operativa||'')}</td>
        <td class="amount">$${esc(r.monto||'')}</td>
        <td>${badge(r.estado||'')}</td>
        <td>${r.comprobante_url ? `<a href="${r.comprobante_url}" target="_blank">Ver</a>` : `<span class="text-muted">-</span>`}</td>
        
        <td style="text-align: center;">
           ${hasNote 
             ? `<button class="btn" style="padding:4px 8px; font-size:16px;" onclick="goToNotesTab('${r.transfer_id}')">üìù</button>` 
             : `<span class="text-muted">-</span>`
           }
        </td>

        <td>
          <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="openEditTransfer('${r.transfer_id}')">
            Editar
          </button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }).listTransfersByUser(selectedUser.user_id, 50);
}

  function saveTransfer(){
  if (!selectedUser) return;
  
  // Capturamos el valor de la nueva billetera
  const billeteraVal = document.getElementById('billetera').value;

  status('stCreateTransfer','Guardando transferencia...');
  
  google.script.run.withFailureHandler(err=>{
    status('stCreateTransfer','Error: ' + (err && err.message ? err.message : err));
  }).withSuccessHandler(res=>{
    if (res.error) return status('stCreateTransfer', res.error);
    const transferId = res.transfer_id;

    if (UP.base64 && UP.mime) {
      status('stCreateTransfer','Subiendo comprobante a Drive...');
      google.script.run.withFailureHandler(err=>{
        status('stCreateTransfer','Transferencia guardada. Error comprobante: ' + (err && err.message ? err.message : err));
        refreshUserTransfers();
        clearComprobante();
        loadDashboard(true);
      }).withSuccessHandler(r2=>{
        if (r2.error) {
          status('stCreateTransfer', 'Transferencia guardada. Comprobante: ' + r2.error);
          toast('Transferencia guardada, pero fall√≥ el comprobante.', 'warn');
        } else {
          status('stCreateTransfer', 'Transferencia y comprobante guardados OK.');
          toast('Transferencia + comprobante guardados.', 'success');
        }
        refreshUserTransfers();
        clearComprobante();
        loadDashboard(true);
      }).uploadComprobante(UP.base64, UP.mime, transferId);
    } else {
      status('stCreateTransfer','Transferencia guardada (sin comprobante).');
      toast('Transferencia guardada.', 'success');
      refreshUserTransfers();
      loadDashboard(true);
    }

    // Limpiamos los campos incluyendo el nuevo select
    document.getElementById('monto').value = '';
    document.getElementById('nota').value = '';
    document.getElementById('billetera').selectedIndex = 0; // Vuelve a la primera opci√≥n por defecto
    
  }).createTransfer({
    user_id: selectedUser.user_id,
    turno: document.getElementById('turno').value,
    fecha: document.getElementById('fecha').value,
    hora: document.getElementById('hora').value,
    monto: document.getElementById('monto').value,
    nota: document.getElementById('nota').value,
    billetera: billeteraVal // <-- Enviamos el nuevo dato al backend
  });
}

  async function uploadCsv(source='tab'){
    const input = document.getElementById(source === 'quick' ? 'csvFileQuick' : 'csvFileTab');
    const f = input?.files?.[0];

    if (!f) return status('stCsv','Selecciona un CSV.');

    status('stCsv','Leyendo archivo...');
    const b64 = await fileToBase64(f);
    status('stCsv','Importando...');

    google.script.run.withFailureHandler(err=>{
      status('stCsv','Error: ' + (err && err.message ? err.message : err));
    }).withSuccessHandler(res=>{
      if (res.error) return status('stCsv', res.error);

      status('stCsv', `Importado OK. Filas agregadas: ${res.imported}`);
      toast(`CSV importado. Filas nuevas: ${res.imported}`, res.imported > 0 ? 'success' : 'info');

      if (res.imported > 0) {
        document.getElementById('syncAlert').classList.remove('hidden');
        showTab('t0');
        window.scrollTo(0,0);
      } else {
        loadDashboard(true);
      }
    }).importWalletCsv(b64, f.type || 'text/csv', f.name);
  }

  function rangeOpts(fromId, toId){
    const fromEl = document.getElementById(fromId);
    const toEl   = document.getElementById(toId);
    return {
      from: fromEl?.value || '',
      to: toEl?.value || '',
      limit: 300
    };
  }
  function loadNoMatch(){
    status('stNoMatch','Cargando...');

    const mode = document.getElementById('nomatchMode')?.value || 'sync';
    const opts = rangeOpts('nm_from','nm_to');
    opts.mode = mode;

    if (mode === 'sync') {
      opts.from = '';
      opts.to = '';
    }

    google.script.run.withFailureHandler(err=>{
      status('stNoMatch','Error: ' + (err && err.message ? err.message : err));
    }).withSuccessHandler(rows=>{
      const tb = document.getElementById('noMatchRows');
      tb.innerHTML='';
      rows.forEach(r => {
  const tr = document.createElement('tr');
  
  // Renderizamos la fila con la nueva columna
  tr.innerHTML = `
    <td>üë§ ${esc(r.nombre || '')}</td>
    <td>${esc(r.fecha_hora_operativa || '')}</td>
    <td class="amount">$${esc(r.monto ?? '')}</td>
    
    <td>
      ${r.comprobante_url 
        ? `<a href="${r.comprobante_url}" target="_blank" class="badge badge-info" style="cursor:pointer; text-decoration:none;">üìÑ Ver</a>` 
        : `<span class="text-muted">-</span>`
      }
    </td>

    <td><button class="btn" onclick="openEditTransfer('${r.transfer_id}')">Editar</button></td>
  `;
  tb.appendChild(tr);
});

      if (mode === 'sync') {
        status('stNoMatch', `Mostrando ${(rows||[]).length} (max ${opts.limit}) | Fuente: Sin match (por sincronizacion)`);
      } else {
        status('stNoMatch', `Mostrando ${(rows||[]).length} (max ${opts.limit}) | Rango: ${opts.from||'...'} a ${opts.to||'...'}`);
      }
    }).getNoMatchListLive(opts);
  }

  // -------- Modal edit user / transfer (MATCHEAR)
  function openEditUser(){
    if (!selectedUser) return;
    openModal('Editar perfil', selectedUser.user_id, `
      <div class="form-group">
        <label class="form-label">Nombre exacto</label>
        <input class="form-input" id="m_name" value="${escAttr(selectedUser.nombre_canonico||'')}" />
      </div>
      <div class="form-group">
        <label class="form-label">CUIL/CUIT</label>
        <input class="form-input" id="m_cuil" value="${escAttr(selectedUser.cuit_cuil||'')}" />
      </div>
      <div class="form-group">
        <label class="form-label">USUARIO BEAST</label>
        <input class="form-input" id="m_beast" value="${escAttr(selectedUser.user_id_beast||'')}" />
      </div>
      <div class="mt-4">
        <button class="btn btn-primary" onclick="saveEditUser()">Guardar</button>
      </div>
      <div class="status-message" id="m_status"></div>
    `);
}

  function saveEditUser(){
    const id = selectedUser.user_id;
    const nombre = document.getElementById('m_name').value;
    const cuil = document.getElementById('m_cuil').value;
    const beast = document.getElementById('m_beast').value; // Capturar nuevo valor

    document.getElementById('m_status').textContent = 'Guardando...';
    
    google.script.run.withFailureHandler(err=>{
      document.getElementById('m_status').textContent = 'Error: ' + (err && err.message ? err.message : err);
    }).withSuccessHandler(res=>{
      if (res.error) return document.getElementById('m_status').textContent = res.error;
      document.getElementById('m_status').textContent = 'Guardado.';
      toast('Perfil actualizado.', 'success');
      selectUser(id); // Recarga los datos en la vista principal
      setTimeout(closeModal, 400);
      loadDashboard(true);
    }).updateUser(id, { 
        nombre_canonico: nombre, 
        cuit_cuil: cuil, 
        user_id_beast: beast // Enviar al servidor
    });
}

function openEditTransfer(transferId){
    google.script.run.withFailureHandler(async err=>{
      await uiAlert('Error', 'No pude cargar datos.\n' + err.message, 'error');
    }).withSuccessHandler(async res=>{
      if (!res || res.error) return uiAlert('Error', res?.error, 'error');
      const t = res.transfer;
      const u = res.user; // Solo para leer, no editar

      openModal('Editar + Matchear', transferId, `
        <p class="help-text mb-4">Edit√° los datos de la transferencia. El usuario es solo lectura.</p>

        <div class="form-row">
           <div class="form-group">
              <label class="form-label">Turno</label>
              <select class="form-select" id="mx_turno">
                 <option value="MANANA" ${t.turno==='MANANA'?'selected':''}>MA√ëANA</option>
                 <option value="TARDE" ${t.turno==='TARDE'?'selected':''}>TARDE</option>
                 <option value="NOCHE" ${t.turno==='NOCHE'?'selected':''}>NOCHE</option>
              </select>
           </div>
           <div class="form-group">
              <label class="form-label">Billetera</label>
              <select class="form-select" id="mx_billetera">
                 <option value="MANZO" ${t.billetera==='MANZO'?'selected':''}>MANZO</option> 
                 <option value="BARROSO" ${t.billetera==='BARROSO'?'selected':''}>BARROSO</option>
                 <option value="DC" ${t.billetera==='DC'?'selected':''}>DC</option>
                 <option value="AMFRIS" ${t.billetera==='AMFRIS'?'selected':''}>AMFRIS</option>
                 <option value="OTRA" ${t.billetera==='OTRA'?'selected':''}>OTRA</option>
              </select>
           </div>
        </div>

        <div class="form-group">
          <label class="form-label">Fecha/Hora operativa</label>
          <input class="form-input" id="mx_dt" value="${escAttr(t.fecha_hora_operativa||'')}" placeholder="DD/MM/YYYY HH:mm" />
        </div>
        
        <div class="form-group">
          <label class="form-label">Monto</label>
          <input class="form-input" id="mx_monto" type="number" value="${escAttr(t.monto ?? '')}" />
        </div>

        <div class="form-group">
          <label class="form-label">Nota / Observaci√≥n</label>
          <input class="form-input" id="mx_nota" value="${escAttr(t.nota||'')}" placeholder="Ej: Pide comprobante..." />
        </div>

        <div class="divider"></div>

        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:16px;">
           <label class="form-label" style="margin-bottom:4px;">Usuario Asociado</label>
           <div style="font-weight:600; color:#fff;">üë§ ${esc(u.nombre_canonico)}</div>
           <div style="font-size:12px; color:#aaa;">CUIL: ${esc(u.cuit_cuil)}</div>
        </div>

        <div class="flex gap-3 flex-wrap items-center justify-between">
          <div class="flex gap-2 items-center">
             <button class="btn btn-primary" onclick="matchearTransfer('${transferId}')">Matchear</button>
             <button class="btn" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2);" onclick="saveOnlyTransfer('${transferId}')">Guardar</button>
             <span class="chip">${esc(t.estado||'Pendiente')}</span>
          </div>
          <button class="btn btn-danger" onclick="confirmDeleteTransfer('${transferId}')">Eliminar</button>
        </div>
        
        <div class="mt-2 text-right">
           ${t.comprobante_url ? `<a class="chip" href="${t.comprobante_url}" target="_blank">Ver comprobante</a>` : `<span class="chip">Sin comprobante</span>`}
        </div>

        <div class="status-message" id="mx_status"></div>
      `);
    }).getTransferEditData(transferId);
  }

function saveOnlyTransfer(transferId){
    const dt = document.getElementById('mx_dt').value.trim();
    const monto = document.getElementById('mx_monto').value;
    const turno = document.getElementById('mx_turno').value;
    const billetera = document.getElementById('mx_billetera').value; // Nuevo
    const nota = document.getElementById('mx_nota').value.trim(); // Nuevo

    document.getElementById('mx_status').textContent = 'Guardando cambios...';

    google.script.run.withFailureHandler(err=>{
       document.getElementById('mx_status').textContent = 'Error: ' + err.message;
    }).withSuccessHandler(res=>{
       if(res.error) {
         document.getElementById('mx_status').textContent = res.error;
       } else {
         toast('Cambios guardados.', 'success');
         closeModal();
         if (selectedUser) refreshUserTransfers(); 
         loadDashboard(true); 
         const t3 = document.getElementById('t3');
         if (!t3.classList.contains('hidden')) loadNoMatch();
       }
    }).saveTransferChanges({
      transfer_id: transferId,
      transfer_patch: {
        fecha_hora_operativa: dt || undefined,
        monto: (monto === '' ? undefined : monto),
        turno: turno,
        billetera: billetera,
        nota: nota
      }
      // YA NO ENVIAMOS user_patch
    });
}

  async function matchearTransfer(transferId){
    const dt = document.getElementById('mx_dt').value.trim();
    const monto = document.getElementById('mx_monto').value;
    const turno = document.getElementById('mx_turno').value;
    const billetera = document.getElementById('mx_billetera').value;
    const nota = document.getElementById('mx_nota').value.trim();

    document.getElementById('mx_status').textContent = 'Matcheando...';

    google.script.run.withFailureHandler(async err=>{
      document.getElementById('mx_status').textContent = 'Error: ' + err.message;
      await uiAlert('Error', 'Fall√≥ el matcheo.\n' + err.message, 'error');
    }).withSuccessHandler(async res=>{
      if (res.error) {
        document.getElementById('mx_status').textContent = res.error;
        return;
      }
      if (res.matched) {
        toast('Match encontrado ‚úÖ', 'success');
        if (selectedUser) refreshUserTransfers();
        loadNoMatch();
        loadDashboard(true);
        closeModal(); // Cerramos si hubo √©xito
        return;
      }

      document.getElementById('mx_status').textContent = `Sin match (${res.estado}). Motivo: ${res.reason}`;
      
      // ... (El resto de la l√≥gica de Estafador queda igual) ...
      // SOLO COPI√Å HASTA AC√Å SI EL RESTO NO LO CAMBIASTE, O REVIS√Å EL BLOQUE DE CONFIRMACI√ìN DE ABAJO
      
      const confirmEstafador = await uiConfirm({
         title: 'NO HAY MATCH',
         message: 'No se encontr√≥ coincidencia.\n¬øMarcar como Estafador?',
         okText: 'S√≠, es estafa', cancelText: 'Seguir buscando', tone: 'warn'
      });
      
      if(confirmEstafador) {
         google.script.run.withSuccessHandler(()=>{
            toast('Marcado como Estafador.', 'success');
            loadDashboard(true);
            closeModal();
         }).markTransferAsEstafador(transferId);
      }

    }).matchTransferAndUpdate({
      transfer_id: transferId,
      transfer_patch: {
        fecha_hora_operativa: dt || undefined,
        monto: (monto === '' ? undefined : monto),
        turno: turno,
        billetera: billetera,
        nota: nota
      }
    });
}
  async function confirmDeleteTransfer(transferId){
    // Usamos tu sistema de confirmaci√≥n UI (uiConfirm)
    const sure = await uiConfirm({
      title: 'Eliminar Transferencia',
      message: '¬øEst√°s segura de que quer√©s borrar esta transferencia?\nEsta acci√≥n es permanente y no se puede deshacer.',
      okText: 'S√≠, borrar',
      cancelText: 'Cancelar',
      tone: 'error', 
      danger: true
    });

    if (!sure) return; // Si dice que no, cancelamos.

    // Feedback visual
    document.getElementById('mx_status').textContent = 'Eliminando...';
    
    google.script.run
      .withFailureHandler(err => {
        uiAlert('Error', 'No se pudo eliminar: ' + err.message, 'error');
      })
      .withSuccessHandler(res => {
        if (res.error) {
           uiAlert('Error', res.error, 'error');
        } else {
           toast('Transferencia eliminada.', 'success');
           closeModal();
           
           // Refrescamos todo para que desaparezca de la lista
           if (selectedUser) refreshUserTransfers();
           loadDashboard(true);
           const t3 = document.getElementById('t3');
           if (!t3.classList.contains('hidden')) loadNoMatch();
        }
      })
      .deleteTransfer(transferId);
  }

// ---------------------------------------------------------
  // FUNCI√ìN loadDashboard
  // ---------------------------------------------------------

  function loadDashboard(silent){
    if (!silent) status('dashStatus','Cargando dashboard...');
    
    google.script.run.withFailureHandler(err=>{
      status('dashStatus','Error: ' + (err && err.message ? err.message : err));
    }).withSuccessHandler(res=>{
      if (!res || res.error) return status('dashStatus', res?.error || 'Error dashboard.');

      // 1. Actualizar Textos y KPIs
      document.getElementById('dashUpdated').textContent = res.updated_at || '-';
      document.getElementById('dashWindow').textContent = `Rango: ${res.window_from} a ${res.window_to}`;
      document.getElementById('topRight').textContent = `Actualizado: ${res.updated_at}`;

      const t = res.totals || {};
      document.getElementById('k_total').textContent = t.total24h ?? 0;
      document.getElementById('k_match').textContent = t.matchCount ?? 0;
      document.getElementById('k_pend').textContent = t.pendingCount ?? 0;
      document.getElementById('k_nomatch').textContent = t.noMatchCount ?? 0;

      // 2. RENDERIZAR GR√ÅFICO (Modificado)
      const ctxElement = document.getElementById('kpiChart');
      
      if (ctxElement) {
        const ctx = ctxElement.getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: res.chart.labels,
            datasets: [{
              label: 'Cantidad de Transferencias', // <--- CAMBIO DE ETIQUETA
              data: res.chart.data,
              backgroundColor: 'rgba(245, 158, 11, 0.6)',
              borderColor: '#f59e0b',
              borderWidth: 1,
              borderRadius: 4,
              barThickness: 'flex',
              maxBarThickness: 40
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1f2937',
                titleColor: '#f3f4f6',
                bodyColor: '#d1d5db',
                borderColor: '#374151',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { 
                  color: '#71717a', 
                  font: { size: 11 },
                  stepSize: 1 // Para que no muestre decimales (1.5 transferencias)
                }
              },
              x: {
                grid: { display: false },
                ticks: { color: '#a1a1aa', font: { size: 11 } }
              }
            }
          }
        });
      }

      // 3. Tabla
      DASH_DATA = res.latest || [];
      DASH_PAGE = 1; 
      renderDashTable();

      status('dashStatus','');
    }).getDashboardData();
  }

  function changeDashPage(delta) {
    const maxPage = Math.ceil(DASH_DATA.length / DASH_SIZE) || 1;
    const newPage = DASH_PAGE + delta;
    if (newPage >= 1 && newPage <= maxPage) {
      DASH_PAGE = newPage;
      renderDashTable();
    }
  }

  function renderDashTable() {
    const tb = document.getElementById('dashLatest');
    tb.innerHTML = '';

    if (!Array.isArray(DASH_DATA) || DASH_DATA.length === 0) {
      tb.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#666;">
        Sin transferencias para mostrar.
      </td></tr>`;
      document.getElementById('pageIndicator').textContent = `P√°gina 1 de 1`;
      document.getElementById('btnPrev').disabled = true;
      document.getElementById('btnNext').disabled = true;
      return;
    }

    const maxPage = Math.ceil(DASH_DATA.length / DASH_SIZE) || 1;
    if (DASH_PAGE > maxPage) DASH_PAGE = maxPage;

    const start = (DASH_PAGE - 1) * DASH_SIZE;
    const end = start + DASH_SIZE;
    const pageItems = DASH_DATA.slice(start, end);

    pageItems.forEach(x => {
      const tr = document.createElement('tr');
      // Detectamos si hay nota extra (tiene el pipe |)
      const hasNote = (x.nota && x.nota.includes('|')); 
      
      tr.innerHTML = `
        <td>üë§ ${esc((x.nombre || x.nombre_canonico || 'Desconocido'))}</td>
        <td class="amount">$${esc(x.monto ?? '')}</td>
        <td>${esc(x.hora || x.fecha_hora_operativa || '')}</td>
        <td>${badge(x.estado || '')}</td>
        
        <td style="text-align: center;">
           ${hasNote 
             ? `<button class="btn" style="padding:4px 8px; font-size:16px;" onclick="goToNotesTab('${x.transfer_id}')" title="Ver nota">üìù</button>` 
             : `<span class="text-muted" style="font-size:10px;">-</span>`
           }
        </td>

        <td><button class="btn" onclick="openEditTransfer('${x.transfer_id}')">Editar</button></td>
      `;
      tb.appendChild(tr);
    });

    document.getElementById('pageIndicator').textContent = `P√°gina ${DASH_PAGE} de ${maxPage}`;
    document.getElementById('btnPrev').disabled = (DASH_PAGE === 1);
    document.getElementById('btnNext').disabled = (DASH_PAGE >= maxPage);
  }

  function syncTransfers(){
    status('dashStatus','Sincronizando (24hs)...');
    
    // Feedback visual en el bot√≥n del cartel (si se us√≥ ese)
    const alertBtn = document.querySelector('#syncAlert .btn');
    if(alertBtn) { alertBtn.textContent = "Sincronizando..."; alertBtn.disabled = true; }

    google.script.run.withFailureHandler(err=>{
      status('dashStatus','Error: ' + (err && err.message ? err.message : err));
      if(alertBtn) { alertBtn.textContent = "Sincronizar ahora"; alertBtn.disabled = false; }
    }).withSuccessHandler(res=>{
      if (res.error) return status('dashStatus', res.error);
      
      status('dashStatus', `OK | Procesadas: ${res.processed} | Match: ${res.setMatch} | Sin match: ${res.setNoMatch} | Estafador skip: ${res.skippedEstafador}`);
      toast('Sincronizaci√≥n finalizada.', 'success');
      
      // --- OCULTAR EL AVISO AL TERMINAR ---
      document.getElementById('syncAlert').classList.add('hidden');
      if(alertBtn) { alertBtn.textContent = "Sincronizar ahora"; alertBtn.disabled = false; }
      // ------------------------------------

      loadDashboard(true);
      const t3 = document.getElementById('t3');
      if (!t3.classList.contains('hidden')) loadNoMatch();
    }).syncTransfers24h();
  }

  // -------- Modal helpers (modal grande)
  function openModal(title, sub, html){
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalSub').textContent = sub ? ('| '+sub) : '';
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalBack').style.display = 'flex';
  }
  function closeModal(){ document.getElementById('modalBack').style.display = 'none'; }

  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
  function escAttr(s){ return esc(s).replace(/"/g,'&quot;'); }

  function badge(state){
    const s = String(state||'').trim();
    let cls='badge-info';
    
    if (s==='Match') cls='badge-success';
    else if (s==='Pendiente' || s==='') cls='badge-info';
    else if (s==='Sin match') cls='badge-error';
    else if (s==='Estafador') cls='badge-error';
    
    // --- ESTA ES LA L√çNEA QUE DA EL COLOR AMARILLO ---
    else if (s==='Duplicada') cls='badge-warning'; 
    // ------------------------------------------------
    
    return `<span class="badge ${cls}">${esc(s || 'Pendiente')}</span>`;
  }

  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result).split(',')[1]);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function setDefaultRanges(){
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    const fromDate = new Date(today.getTime() - 7*24*60*60*1000);
    const from = fromDate.toISOString().slice(0,10);

    const fromEl = document.getElementById('nm_from');
    const toEl   = document.getElementById('nm_to');

    if (fromEl) fromEl.value = from;
    if (toEl)   toEl.value = to;
  }

  // init
  setDefaultRanges();
  searchUsers();
  loadDashboard(false);
  setInterval(()=>loadDashboard(true), 20000);

  // -------------------- FUNCIONES DE CIERRE --------------------

  async function handleCleanDrive() {
    const sure = await uiConfirm({
      title: '¬øVaciar Comprobantes?',
      message: 'Esto eliminar√° todas las im√°genes de la carpeta de Drive.\n¬øEst√°s seguro?',
      okText: 'S√≠, vaciar',
      cancelText: 'Cancelar',
      tone: 'error',
      danger: true
    });
    if (!sure) return;

    const pwd = prompt("üîí Ingresa la contrase√±a para confirmar:");
    if (!pwd) return;

    status('stCierre', 'Vaciando carpeta...');
    
    google.script.run
      .withFailureHandler(err => status('stCierre', 'Error: ' + err.message))
      .withSuccessHandler(res => {
        if (res.error) {
          alert(res.error);
          status('stCierre', 'Error de contrase√±a.');
        } else {
          status('stCierre', `Listo. Se movieron ${res.count} archivos a la papelera.`);
          toast(`Carpeta vaciada (${res.count} archivos).`, 'success');
        }
      })
      .deleteAllComprobantes(pwd);
  }

  async function handleCleanHistory() {
    const sure = await uiConfirm({
      title: '¬øBorrar Historial Completo?',
      message: 'ATENCI√ìN: Se borrar√°n todas las transferencias, movimientos y reportes.\n\nEl sistema quedar√° en cero (solo quedar√°n los clientes).\nEsta acci√≥n NO se puede deshacer.',
      okText: 'S√≠, borrar todo',
      cancelText: 'Cancelar',
      tone: 'error',
      danger: true
    });
    if (!sure) return;

    const pwd = prompt("üîí Ingresa la contrase√±a para confirmar:");
    if (!pwd) return;

    status('stCierre', 'Limpiando base de datos...');

    google.script.run
      .withFailureHandler(err => status('stCierre', 'Error: ' + err.message))
      .withSuccessHandler(res => {
        if (res.error) {
          alert(res.error);
          status('stCierre', 'Error de contrase√±a.');
        } else {
          status('stCierre', 'Sistema reiniciado correctamente.');
          toast('Historial eliminado. Sistema limpio.', 'success');
          loadDashboard(true); // Refrescar para ver todo en 0
        }
      })
      .deleteAllHistory(pwd);
  }

  function showTab(id){
     ['t0','t1','t2','t3','t4','t5'].forEach(t=>document.getElementById(t).classList.add('hidden')); // Agregu√© t4
     document.getElementById(id).classList.remove('hidden');
     
     let btn='tab0';
     if(id==='t1') btn='tab1';
     else if(id==='t2') btn='tab2';
     else if(id==='t3') btn='tab3';
     else if(id==='t4') btn='tab4'; // Agregu√© t4
     else if(id==='t5') btn='tab5';
     
     setTabBtn(btn);

     if(id === 't3') { loadNoMatch(); loadOrphans(); }
     if(id === 't4') { loadNotesTab(); } // NUEVO: Cargar notas al entrar
  }

  // --- AGREGAR ESTA FUNCI√ìN AL FINAL DEL SCRIPT ---
  function loadOrphans(){
    const query = document.getElementById('qOrphan').value; // Capturamos el texto
    
    status('stOrphans', 'Buscando...');
    const tb = document.getElementById('orphanRows');
    tb.innerHTML = '';

    google.script.run
      .withFailureHandler(err => {
        status('stOrphans', 'Error: ' + err.message);
      })
      .withSuccessHandler(rows => {
        if (!rows || rows.length === 0) {
          status('stOrphans', 'No se encontraron ingresos recientes sin registrar.');
          return;
        }

        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><span style="color:#fff; font-weight:500;">üë§ ${esc(r.nombre)}</span></td>
            <td>${esc(r.fecha)}</td>
            <td class="amount" style="color: #4ade80;">+$${esc(r.monto)}</td>
          `;
          tb.appendChild(tr);
        });
        status('stOrphans', `Mostrando ${rows.length} ingresos (Ayer/Hoy).`);
      })
      .getWalletOrphans(query); // Enviamos el texto al backend
  }

  function openLogs() {
    openModal('Logs de Auditor√≠a', '√öltimos 50 eventos', `
      <div style="max-height: 400px; overflow-y: auto;">
        <table class="data-table">
          <thead><tr><th>Fecha</th><th>Acci√≥n</th><th>Usuario</th><th>Detalle</th></tr></thead>
          <tbody id="logsBody"><tr><td colspan="4">Cargando...</td></tr></tbody>
        </table>
      </div>
    `);

    google.script.run.withSuccessHandler(logs => {
      const tb = document.getElementById('logsBody');
      tb.innerHTML = '';
      logs.forEach(l => {
        tb.innerHTML += `
          <tr>
            <td style="white-space:nowrap; font-size:11px;">${l.fecha}</td>
            <td>${badge(l.accion)}</td>
            <td style="font-size:11px;">${esc(l.usuario)}</td>
            <td style="font-size:11px; color:#aaa;">${esc(l.detalle)}</td>
          </tr>
        `;
      });
    }).getSystemLogs(50);
  }

  function loadNotesTab(){
    const tb = document.getElementById('notesRows');
    tb.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Cargando notas...</td></tr>';

    google.script.run.withSuccessHandler(rows => {
      tb.innerHTML = '';
      if(!rows || rows.length === 0){
        tb.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No hay transferencias con notas extra.</td></tr>';
        return;
      }
      
      rows.forEach(r => {
        const tr = document.createElement('tr');
        // Usamos un estilo especial para resaltar la nota
        tr.innerHTML = `
          <td>${esc(r.fecha)}</td>
          <td>üë§ ${esc(r.nombre)}</td>
          <td class="amount">$${esc(r.monto)}</td>
          <td style="color: #fbbf24; font-weight: 500;">${esc(r.mensaje_corto)}</td>
          <td>
             <button class="btn" onclick="openEditTransfer('${r.transfer_id}')">Editar</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }).getTransfersWithNotes();
  }

  // Funci√≥n puente para ir a la pesta√±a
  function goToNotesTab(transferId){
     showTab('t4');
     // Podr√≠amos agregar l√≥gica para resaltar la fila, pero por ahora con ir alcanza.
  }

</script>
</body>
</html>
